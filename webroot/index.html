<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8">
  <link rel="icon" href="data:,">

  <title>OAuth2 Worker Demo</title>

  <script src="oauth2.js"></script>
 </head>
 <body>
  <table>
   <tr>
    <th>Name:</th>
    <td id="name">...</td>
   </tr>
   <tr>
    <th>Email:</th>
    <td id="email">...</td>
   </tr>
   <tr>
    <th>Login:</th>
    <td><button id="button" disabled>Loading...</button>
   </tr>
  </table>
  <script>
    const authorize = (promise) => {
      const button = document.getElementById('button');
      button.textContent = 'Login';
      button.removeAttribute('disabled');
      button.onclick = function(e) {
        e.preventDefault();

        new Promise((resolve, reject) => {
          button.setAttribute('disabled', '');
          button.textContent = 'Logging in...';
          promise.resolve({ resolve: resolve, reject: reject });
        }).then(
	  data => {
            console.log('success', data);
            button.textContent = 'Logged in';
          },
          data => {
            console.log('failed', data);
            button.textContent = 'Login Failed';
          }
        ).catch(error => {
          console.log('error', error);
          button.textContent = 'Login Error';
        });
      };
    };

    const oauth2 = new OAuth2({
      client_id: '3ea93227a55ed2db80cfbd51db973eed63fe3158167524bf64520985043b3fed',
      client_secret: '0cf9acef62f593859797cc3e31a2392f88ce7ab8bdf760f0173f6d11d5c05fbc',
      redirect_uri: '/oauth2-redirect.html',
      discovery_endpoint: 'https://gitlab.com',
      authorize_callback: authorize,
      scopes: [ 'openid', 'email', 'profile' ]
    });
    oauth2.whoami().then(whoami => {
      document.getElementById('name').textContent = whoami.name;
      document.getElementById('email').textContent = whoami.email;
    });
    oauth2.fetch(location.origin + '/userinfo').then(response => {
      console.log('fetch', response)
    });
  </script>
 </body>
</html>
